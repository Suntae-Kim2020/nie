<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>워드 클라우드 생성기</title>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .input-tabs {
            display: flex;
            border-bottom: 2px solid #e1e1e1;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: #f8f9fa;
            border-bottom-color: #4facfe;
            color: #4facfe;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .file-upload-area {
            border: 2px dashed #e1e1e1;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #4facfe;
            background: #f8f9fa;
        }

        .file-upload-area.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
        }

        .file-input {
            display: none;
        }

        .file-upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .file-upload-hint {
            color: #999;
            font-size: 14px;
        }

        .uploaded-file {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            width: 24px;
            height: 24px;
            background: #4caf50;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .remove-file {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input[type="url"], input[type="number"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="url"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.5;
        }
        
        .char-counter {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .char-counter.warning {
            color: #ff6b6b;
            font-weight: bold;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-download {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .wordcloud-container {
            margin-top: 30px;
            text-align: center;
        }

        #wordcloud {
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            margin: 20px auto;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>워드 클라우드 생성기</h1>
            <p>URL 또는 PDF 파일을 사용하여 아름다운 워드 클라우드를 만들어보세요</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <div class="input-tabs">
                    <button class="tab-button active" onclick="switchTab('url')">텍스트 입력</button>
                    <button class="tab-button" onclick="switchTab('pdf')">PDF 파일</button>
                </div>
                
                <div id="url-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="textInput">텍스트 입력 (최대 500,000자)</label>
                        <textarea id="textInput" 
                                 placeholder="분석할 텍스트를 여기에 붙여넣어 주세요...&#10;&#10;예시:&#10;국립생태원은 생태계 보전과 복원을 위한 연구기관입니다.&#10;기후변화와 생물다양성 보전에 힘쓰고 있습니다.&#10;&#10;• 웹페이지 텍스트를 복사해서 붙여넣으세요&#10;• 한국어, 영어 모두 지원&#10;• 긴 문서도 처리 가능합니다"
                                 maxlength="500000"
                                 rows="8"></textarea>
                        <div class="char-counter">
                            <span id="charCount">0</span> / 500,000자
                        </div>
                    </div>
                </div>
                
                <div id="pdf-tab" class="tab-content">
                    <div class="form-group">
                        <label>PDF 파일 업로드</label>
                        <div class="file-upload-area" onclick="document.getElementById('pdfInput').click()">
                            <input type="file" id="pdfInput" class="file-input" accept=".pdf" onchange="handleFileSelect(event)">
                            <div class="file-upload-text">PDF 파일을 선택하거나 여기에 드래그하세요</div>
                            <div class="file-upload-hint">최대 파일 크기: 20MB</div>
                        </div>
                        <div id="uploadedFile" class="uploaded-file" style="display: none;">
                            <div class="file-info">
                                <div class="file-icon">PDF</div>
                                <span id="fileName"></span>
                            </div>
                            <button class="remove-file" onclick="removeFile()">제거</button>
                        </div>
                    </div>
                </div>
                
                <div class="options-grid">
                    <div class="form-group">
                        <label for="shapeSelect">모양</label>
                        <select id="shapeSelect">
                            <option value="circle">원형</option>
                            <option value="cardioid">하트</option>
                            <option value="diamond">다이아몬드</option>
                            <option value="triangle">삼각형</option>
                            <option value="pentagon">오각형</option>
                            <option value="star">별</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="colorMode">색상 모드</label>
                        <select id="colorMode">
                            <option value="color">컬러</option>
                            <option value="grayscale">흑백</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sizeSelect">크기</label>
                        <select id="sizeSelect">
                            <option value="small">작음 (400x300)</option>
                            <option value="medium" selected>보통 (600x450)</option>
                            <option value="large">큼 (800x600)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="wordCountInput">단어 개수</label>
                        <input type="number" id="wordCountInput" min="10" max="200" value="100" placeholder="100">
                    </div>
                </div>
                
                <button class="btn" id="generateBtn" onclick="generateWordCloud()">
                    워드 클라우드 생성
                </button>
                
                <button class="btn btn-download hidden" id="downloadBtn" onclick="downloadWordCloud()">
                    이미지 다운로드
                </button>
            </div>
            
            <div class="status" id="status"></div>
            
            <div class="wordcloud-container">
                <canvas id="wordcloud"></canvas>
            </div>
        </div>
    </div>

    <script>
        let currentWordCloud = null;
        let canvasSize = { width: 600, height: 450 };
        let currentFile = null;
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.innerHTML = message;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        function getCanvasSize() {
            const size = document.getElementById('sizeSelect').value;
            switch(size) {
                case 'small': return { width: 400, height: 300 };
                case 'medium': return { width: 600, height: 450 };
                case 'large': return { width: 800, height: 600 };
                default: return { width: 600, height: 450 };
            }
        }

        function createShapeMask(shape, canvasWidth, canvasHeight) {
            const canvas = document.createElement('canvas');
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            const ctx = canvas.getContext('2d');
            
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;
            const size = Math.min(canvasWidth, canvasHeight) * 0.4;
            
            ctx.fillStyle = '#000000';
            
            switch(shape) {
                case 'circle':
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, size, 0, 2 * Math.PI);
                    ctx.fill();
                    break;
                    
                case 'cardioid':
                    ctx.beginPath();
                    for (let t = 0; t <= 2 * Math.PI; t += 0.01) {
                        const r = size * 0.3 * (1 - Math.cos(t));
                        const x = centerX + r * Math.cos(t);
                        const y = centerY + r * Math.sin(t);
                        if (t === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.fill();
                    break;
                    
                case 'diamond':
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY - size);
                    ctx.lineTo(centerX + size, centerY);
                    ctx.lineTo(centerX, centerY + size);
                    ctx.lineTo(centerX - size, centerY);
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                case 'triangle':
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY - size);
                    ctx.lineTo(centerX + size * Math.cos(Math.PI/6), centerY + size * Math.sin(Math.PI/6));
                    ctx.lineTo(centerX - size * Math.cos(Math.PI/6), centerY + size * Math.sin(Math.PI/6));
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                case 'pentagon':
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 2 * Math.PI / 5) - Math.PI/2;
                        const x = centerX + size * Math.cos(angle);
                        const y = centerY + size * Math.sin(angle);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                case 'star':
                    ctx.beginPath();
                    for (let i = 0; i < 10; i++) {
                        const angle = (i * Math.PI / 5) - Math.PI/2;
                        const radius = i % 2 === 0 ? size : size * 0.4;
                        const x = centerX + radius * Math.cos(angle);
                        const y = centerY + radius * Math.sin(angle);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                default:
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, size, 0, 2 * Math.PI);
                    ctx.fill();
                    break;
            }
            
            return canvas;
        }

        function createWordCloudShape(shape, canvasWidth, canvasHeight) {
            // Fallback to polar function for compatibility
            const size = Math.min(canvasWidth, canvasHeight) * 0.4;
            
            switch(shape) {
                case 'circle':
                    return function(theta) { return size; };
                    
                case 'cardioid':
                    return function(theta) {
                        const r = size * 0.3 * (1 - Math.cos(theta));
                        return Math.max(size * 0.1, r);
                    };
                    
                case 'diamond':
                    return function(theta) {
                        const normalizedTheta = ((theta % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                        const x = Math.abs(Math.cos(normalizedTheta));
                        const y = Math.abs(Math.sin(normalizedTheta));
                        return size * 0.8 / Math.max(x, y, 0.1);
                    };
                    
                case 'triangle':
                case 'pentagon':
                case 'star':
                    // 복잡한 모양들은 마스크 사용
                    return function(theta) { return size * 0.8; };
                    
                default:
                    return function(theta) { return size; };
            }
        }

        function getColorFunction() {
            const colorMode = document.getElementById('colorMode').value;
            
            if (colorMode === 'grayscale') {
                return function(word, weight, fontSize) {
                    // 글자 크기에 따른 명도 조절
                    const intensity = Math.max(50, Math.min(200, fontSize * 3));
                    return `rgb(${intensity}, ${intensity}, ${intensity})`;
                };
            } else {
                const colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
                    '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                    '#74B9FF', '#00B894', '#FDCB6E', '#E17055'
                ];
                return function(word, weight, fontSize) {
                    // 단어의 해시값을 이용해 일관된 색상 선택
                    let hash = 0;
                    for (let i = 0; i < word.length; i++) {
                        hash = word.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    const colorIndex = Math.abs(hash) % colors.length;
                    return colors[colorIndex];
                };
            }
        }

        async function fetchWebPageText(url) {
            // CORS 정책으로 인해 외부 웹페이지 접근이 제한됩니다
            alert('CORS 정책으로 인해 외부 웹페이지에 직접 접근할 수 없습니다.\n\n해결방법:\n1. 웹페이지의 텍스트를 직접 복사해서 붙여넣기 하세요\n2. 또는 아래 샘플 텍스트를 사용하세요');
            
            // 국립생태원 샘플 텍스트 제공
            const sampleText = `
            국립생태원 원장 인사말
            
            안녕하십니까. 국립생태원장 이창석입니다.
            
            기후변화와 생물다양성 감소 등 전 지구적 환경 문제가 심화되고 있는 가운데, 
            국립생태원은 생태계의 다양성을 보전하고 관리하는 중추적 역할을 담당하고 있습니다.
            
            국립생태원은 생태 다양성 보전 및 관리, 탄소중립 목표 달성 지원, 
            환경 복원 도구 개발, 생태 교육 프로그램 제공, ESG 경영 실천을 주요 목표로 하고 있습니다.
            
            저희는 과학적 연구와 실증을 바탕으로 생태계 보전과 복원에 최선을 다하고 있으며, 
            국민 여러분께 양질의 생태 서비스를 제공하겠습니다.
            
            앞으로도 국립생태원에 대한 여러분의 관심과 성원을 부탁드리며, 
            지속가능한 미래를 위해 함께 노력해 나가겠습니다.
            
            국립생태원장 이창석
            `;
            
            return sampleText;
        }

        function processTextForWordCloud(text) {
            const koreanStopWords = new Set([
                '이', '그', '저', '것', '수', '있', '하', '되', '된', '될', '와', '과', '를', '을', '는', '은', '가', '이', '에', '의', '로', '으로', '에서', '까지', '부터', '같이', '처럼', '보다', '만큼', '에게', '한테', '께', '더', '가장', '매우', '너무', '정말', '진짜', '또', '그리고', '하지만', '그러나', '그런데', '또한', '역시', '물론', '당연히', '아마', '혹시', '만약', '그래서', '따라서', '왜냐하면', '때문에'
            ]);
            
            const englishStopWords = new Set([
                'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'her', 'its', 'our', 'their'
            ]);

            const words = text
                .replace(/[^\w\sㄱ-ㅎㅏ-ㅣ가-힣]/g, ' ') // 특수문자 제거
                .toLowerCase()
                .split(/\s+/)
                .filter(word => {
                    if (word.length < 1) return false; // 1글자 이상으로 완화
                    if (koreanStopWords.has(word)) return false;
                    if (englishStopWords.has(word)) return false;
                    if (/^\d+$/.test(word)) return false; // 순수 숫자 제외
                    if (/^[a-z]$/.test(word)) return false; // 영어 단일 문자 제외
                    return true;
                });
                
            console.log('Words after filtering:', words.length);
            console.log('Sample words:', words.slice(0, 20));

            const wordCount = {};
            words.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });

            const maxWords = Math.min(parseInt(document.getElementById('wordCountInput').value) || 100, 200);
            
            console.log('Total unique words before filtering:', Object.keys(wordCount).length);
            console.log('Word count sample:', Object.entries(wordCount).slice(0, 10));

            // 최소 출현 빈도를 1로 변경 (모든 단어 포함)
            const filteredWords = Object.entries(wordCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, maxWords)
                .filter(([word, count]) => count >= 1); // 1로 변경
                
            console.log('Filtered words count:', filteredWords.length);
            
            return filteredWords.map(([word, count]) => [word, count]);
        }

        async function generateWordCloud() {
            const urlInput = document.getElementById('urlInput');
            const generateBtn = document.getElementById('generateBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const activeTab = document.querySelector('.tab-button.active').textContent;
            
            let text = '';
            
            if (activeTab === '텍스트 입력') {
                const textInput = document.getElementById('textInput');
                if (!textInput.value.trim()) {
                    showStatus('텍스트를 입력해주세요.', 'error');
                    return;
                }
                if (textInput.value.trim().length < 10) {
                    showStatus('최소 10자 이상 입력해주세요.', 'error');
                    return;
                }
            } else if (activeTab === 'PDF 파일') {
                if (!currentFile) {
                    showStatus('PDF 파일을 선택해주세요.', 'error');
                    return;
                }
            }

            try {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<span class="loading-spinner"></span>워드 클라우드 생성 중...';
                downloadBtn.classList.add('hidden');
                
                if (activeTab === '텍스트 입력') {
                    showStatus('텍스트를 분석하는 중...', 'loading');
                    text = document.getElementById('textInput').value.trim();
                } else {
                    showStatus('PDF에서 텍스트를 추출하는 중...', 'loading');
                    text = await extractTextFromPDF(currentFile);
                }
                
                showStatus('텍스트를 분석하고 워드 클라우드를 생성하는 중...', 'loading');
                
                console.log('Raw text length:', text.length);
                console.log('Raw text preview:', text.substring(0, 200));
                
                const wordList = processTextForWordCloud(text);
                
                console.log('Word list length:', wordList.length);
                console.log('Word list:', wordList.slice(0, 10));
                
                if (wordList.length === 0) {
                    throw new Error('분석할 수 있는 단어를 찾을 수 없습니다.');
                }
                
                // 단어가 너무 적으면 테스트용 단어 추가
                if (wordList.length < 10) {
                    const additionalWords = [
                        ['분석', 5], ['연구', 4], ['데이터', 4], ['결과', 3], 
                        ['방법', 3], ['시스템', 3], ['개발', 2], ['정보', 2],
                        ['관리', 2], ['평가', 2], ['효과', 2], ['과정', 2]
                    ];
                    wordList.push(...additionalWords.slice(0, 15 - wordList.length));
                    console.log('Extended word list length:', wordList.length);
                }

                // 크기 설정을 다시 가져오기 (PDF 처리 후에)
                canvasSize = getCanvasSize();
                const canvas = document.getElementById('wordcloud');
                console.log('Final canvas size before WordCloud:', canvasSize);
                
                // 캔버스 크기 먼저 설정 (WordCloud 생성 전에)
                canvas.width = canvasSize.width;
                canvas.height = canvasSize.height;
                canvas.style.width = canvasSize.width + 'px';
                canvas.style.height = canvasSize.height + 'px';
                
                // 캔버스 초기화
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 메모리 정리
                if (currentWordCloud && currentWordCloud !== canvas) {
                    const oldCtx = currentWordCloud.getContext('2d');
                    oldCtx.clearRect(0, 0, currentWordCloud.width, currentWordCloud.height);
                }

                const shape = document.getElementById('shapeSelect').value;
                const size = document.getElementById('sizeSelect').value;
                const colorFunction = getColorFunction();
                
                console.log('Selected shape:', shape);
                console.log('Selected size:', size);
                console.log('Canvas size:', canvasSize);

                // 깔끔한 새 설정으로 통일
                console.log('Creating WordCloud with shape:', shape, 'size:', size, 'words:', wordList.length);
                
                // 캔버스 크기에 맞는 shape 함수 생성
                const shapeFunction = createWordCloudShape(shape, canvasSize.width, canvasSize.height);
                
                // 단어 개수 설정
                const maxWords = parseInt(document.getElementById('wordCountInput').value) || 100;
                const finalWordList = wordList.slice(0, maxWords);
                
                console.log('Final word list:', finalWordList.length, 'words');
                
                // WordCloud 옵션 설정
                const options = {
                    list: finalWordList,
                    gridSize: 8,
                    weightFactor: function(size) {
                        return Math.max(12, size * 1.8);
                    },
                    fontFamily: 'Arial, sans-serif',
                    color: colorFunction,
                    rotateRatio: 0.2,
                    backgroundColor: '#ffffff',
                    minSize: 12,
                    drawOutOfBound: false
                };
                
                // shape 옵션 설정
                console.log('Shape selected:', shape);
                if (shape !== 'circle') {
                    if (['triangle', 'pentagon', 'star'].includes(shape)) {
                        console.log('Using mask-based approach for:', shape);
                        const maskCanvas = createShapeMask(shape, canvasSize.width, canvasSize.height);
                        options.mask = maskCanvas;
                    } else {
                        console.log('Using polar function for:', shape);
                        console.log('Testing shape function:');
                        console.log('  At 0°:', shapeFunction(0));
                        console.log('  At 90°:', shapeFunction(Math.PI/2));
                        console.log('  At 180°:', shapeFunction(Math.PI));
                        console.log('  At 270°:', shapeFunction(Math.PI*3/2));
                        options.shape = shapeFunction;
                    }
                } else {
                    console.log('Using default circle shape');
                }
                
                console.log('WordCloud options:', options);

                // WordCloud 생성
                console.log('Creating WordCloud with options:', {
                    shape: shape,
                    wordCount: finalWordList.length,
                    canvasSize: canvasSize,
                    options: options
                });
                
                try {
                    console.log('Calling WordCloud with final options:', options);
                    WordCloud(canvas, options);
                    console.log('WordCloud API called successfully');
                    
                    // 2초 후 생성 확인
                    setTimeout(() => {
                        const ctx = canvas.getContext('2d');
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const hasContent = imageData.data.some((value, index) => {
                            // 알파 채널이 아닌 RGB 값만 확인
                            return index % 4 !== 3 && value !== 255 && value !== 0;
                        });
                        
                        console.log('Canvas has content after 2s:', hasContent);
                        
                        if (!hasContent && shape !== 'circle') {
                            console.log('Shape not working, trying circle fallback...');
                            const fallbackOptions = {
                                ...options,
                                shape: undefined
                            };
                            delete fallbackOptions.shape;
                            WordCloud(canvas, fallbackOptions);
                            showStatus(`${shape} 모양이 지원되지 않아 원형으로 생성했습니다.`, 'success');
                        }
                    }, 2000);
                    
                } catch (error) {
                    console.error('WordCloud generation failed:', error);
                    // 실패시 기본 설정으로 재시도
                    console.log('Retrying with basic options...');
                    const basicOptions = {
                        list: finalWordList,
                        gridSize: 8,
                        weightFactor: 20,
                        fontFamily: 'Arial, sans-serif',
                        color: 'random-dark',
                        backgroundColor: '#ffffff'
                    };
                    WordCloud(canvas, basicOptions);
                }
                
                currentWordCloud = canvas;
                
                hideStatus();
                showStatus(`워드 클라우드가 성공적으로 생성되었습니다! (모양: ${shape}, ${finalWordList.length}개 단어)`, 'success');
                downloadBtn.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus(error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '워드 클라우드 생성';
            }
        }

        function downloadWordCloud() {
            if (!currentWordCloud) {
                showStatus('먼저 워드 클라우드를 생성해주세요.', 'error');
                return;
            }

            try {
                const link = document.createElement('a');
                link.download = `wordcloud_${new Date().getTime()}.png`;
                link.href = currentWordCloud.toDataURL();
                link.click();
                
                showStatus('이미지가 다운로드되었습니다.', 'success');
            } catch (error) {
                showStatus('다운로드 중 오류가 발생했습니다.', 'error');
            }
        }

        // Enter 키 이벤트 리스너를 DOMContentLoaded 내부로 이동

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // 글자 수 카운터 업데이트
        function updateCharCount() {
            const textInput = document.getElementById('textInput');
            const charCount = document.getElementById('charCount');
            const counter = document.querySelector('.char-counter');
            
            const currentLength = textInput.value.length;
            charCount.textContent = currentLength.toLocaleString();
            
            // 글자 수에 따라 색상 변경
            if (currentLength > 450000) {
                counter.classList.add('warning');
            } else {
                counter.classList.remove('warning');
            }
        }
        
        // 페이지 로드 시 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', function() {
            const textInput = document.getElementById('textInput');
            if (textInput) {
                // 입력 이벤트 리스너
                textInput.addEventListener('input', updateCharCount);
                textInput.addEventListener('paste', function() {
                    setTimeout(updateCharCount, 10); // paste 후 업데이트
                });
                
                // Enter 키 이벤트 (텍스트 영역에서는 Ctrl+Enter로 생성)
                textInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        generateWordCloud();
                    }
                });
                
                // 초기 카운트 설정
                updateCharCount();
            }
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type !== 'application/pdf') {
                    showStatus('PDF 파일만 업로드할 수 있습니다.', 'error');
                    return;
                }
                
                if (file.size > 20 * 1024 * 1024) {
                    showStatus('파일 크기는 20MB를 초과할 수 없습니다.', 'error');
                    return;
                }
                
                currentFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('uploadedFile').style.display = 'flex';
                hideStatus();
            }
        }
        
        function removeFile() {
            currentFile = null;
            document.getElementById('pdfInput').value = '';
            document.getElementById('uploadedFile').style.display = 'none';
        }
        
        async function extractTextFromPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + ' ';
                }
                
                if (fullText.trim().length < 100) {
                    throw new Error('PDF에서 충분한 텍스트를 찾을 수 없습니다.');
                }
                
                return fullText;
            } catch (error) {
                console.error('PDF 처리 오류:', error);
                throw new Error('PDF 파일을 처리하는 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 드래그 앤 드롭 기능
        const fileUploadArea = document.querySelector('.file-upload-area');
        if (fileUploadArea) {
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        document.getElementById('pdfInput').files = files;
                        handleFileSelect({ target: { files: files } });
                    } else {
                        showStatus('PDF 파일만 업로드할 수 있습니다.', 'error');
                    }
                }
            });
        }

        document.getElementById('sizeSelect').addEventListener('change', function() {
            if (currentWordCloud) {
                const canvas = document.getElementById('wordcloud');
                canvasSize = getCanvasSize();
                canvas.width = canvasSize.width;
                canvas.height = canvasSize.height;
            }
        });
    </script>
</body>
</html>