<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>조류 충돌 대시보드 (간소화)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Malgun Gothic', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
            border-radius: 10px; 
            margin-bottom: 30px; 
        }
        .filters { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .stat { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 10px; 
        }
        .chart-container { 
            position: relative; 
            height: 300px; 
        }
        select, button { 
            padding: 8px 12px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        button { 
            background: #667eea; 
            color: white; 
            cursor: pointer; 
        }
        button:hover { 
            background: #5a6fd8; 
        }
        .loading { 
            text-align: center; 
            padding: 20px; 
            color: #666; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🐦 조류 유리창 충돌사고 대시보드</h1>
        <p>2023-2024년 전국 데이터 실시간 분석</p>
    </div>

    <div id="status" class="loading">데이터 로딩 중...</div>

    <div class="filters" id="filterSection" style="display: none;">
        <h3>📊 데이터 필터링</h3>
        <select id="yearFilter">
            <option value="all">전체 연도</option>
        </select>
        <select id="regionFilter">
            <option value="all">전체 지역</option>
        </select>
        <select id="facilityFilter">
            <option value="all">전체 시설</option>
        </select>
        <button onclick="applyFilters()">필터 적용</button>
        <button onclick="resetFilters()">초기화</button>
        <button onclick="exportData()">데이터 내보내기</button>
    </div>

    <div class="grid" id="statsGrid" style="display: none;">
        <div class="card">
            <h3>📊 총 사고 건수</h3>
            <div class="stat" id="totalAccidents">0</div>
            <small>전체 기간</small>
        </div>
        <div class="card">
            <h3>🏙️ 영향받은 지역</h3>
            <div class="stat" id="totalRegions">0</div>
            <small>시도</small>
        </div>
        <div class="card">
            <h3>🐦 조류 종 수</h3>
            <div class="stat" id="totalSpecies">0</div>
            <small>종</small>
        </div>
        <div class="card">
            <h3>🏢 주요 시설</h3>
            <div class="stat" id="mainFacility">방음벽</div>
            <small id="facilityPercent">0%</small>
        </div>
    </div>

    <div class="grid" id="chartsGrid" style="display: none;">
        <div class="card">
            <h3>📅 월별 사고 추이</h3>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h3>🗺️ 지역별 분포</h3>
            <div class="chart-container">
                <canvas id="regionChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h3>🦅 조류 종별 분포</h3>
            <div class="chart-container">
                <canvas id="speciesChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h3>🏗️ 시설물별 분포</h3>
            <div class="chart-container">
                <canvas id="facilityChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let filteredData = [];
        let charts = {};

        // 초기화
        async function init() {
            console.log('초기화 시작...');
            
            try {
                await loadData();
                showInterface();
                createCharts();
                updateStats();
                updateMessage('✅ 대시보드 로드 완료', 'success');
            } catch (error) {
                console.error('초기화 실패:', error);
                updateMessage('❌ 초기화 실패: ' + error.message, 'error');
            }
        }

        async function loadData() {
            try {
                console.log('실제 데이터 로딩 시도...');
                const response = await fetch('./bird_analysis_results.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const results = await response.json();
                data = results.raw_data || [];
                
                if (data.length === 0) {
                    throw new Error('데이터가 비어있음');
                }
                
                console.log('✅ 실제 데이터 로드 성공:', data.length, '개');
                
            } catch (error) {
                console.log('실제 데이터 로드 실패, 시뮬레이션 데이터 생성:', error.message);
                generateSimulationData();
            }
            
            filteredData = [...data];
            populateFilters();
        }

        function generateSimulationData() {
            const regions = ['서울특별시', '경기도', '부산광역시', '대구광역시', '광주광역시', '대전광역시', '울산광역시', '인천광역시'];
            const species = ['멧비둘기', '직박구리', '참새', '물까치', '박새', '되지빠귀', '집비둘기', '붉은머리오목눈이'];
            const facilities = ['방음벽', '건물', '기타'];
            
            data = [];
            for (let i = 0; i < 500; i++) {
                // 2024년에 더 많은 가중치 부여 (60% 2024년, 40% 2023년)
                const year = Math.random() < 0.6 ? 2024 : 2023;
                const month = Math.floor(Math.random() * 12);
                const day = Math.floor(Math.random() * 28) + 1;
                const date = new Date(year, month, day);
                
                data.push({
                    관찰일자: date.toISOString().split('T')[0],
                    시도명: regions[Math.floor(Math.random() * regions.length)],
                    한글보통명: species[Math.floor(Math.random() * species.length)],
                    시설물유형명: facilities[Math.floor(Math.random() * facilities.length)],
                    개체수: Math.floor(Math.random() * 5) + 1
                });
            }
            
            console.log('시뮬레이션 데이터 생성:', data.length, '개');
        }

        function populateFilters() {
            // 연도 필터
            const years = [...new Set(data.map(item => new Date(item.관찰일자).getFullYear()))].sort();
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="all">전체 연도</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}년</option>`;
            });

            // 지역 필터
            const regions = [...new Set(data.map(item => item.시도명))].sort();
            const regionFilter = document.getElementById('regionFilter');
            regionFilter.innerHTML = '<option value="all">전체 지역</option>';
            regions.forEach(region => {
                regionFilter.innerHTML += `<option value="${region}">${region}</option>`;
            });

            // 시설물 필터
            const facilities = [...new Set(data.map(item => item.시설물유형명))].sort();
            const facilityFilter = document.getElementById('facilityFilter');
            facilityFilter.innerHTML = '<option value="all">전체 시설</option>';
            facilities.forEach(facility => {
                facilityFilter.innerHTML += `<option value="${facility}">${facility}</option>`;
            });
        }

        function applyFilters() {
            const year = document.getElementById('yearFilter').value;
            const region = document.getElementById('regionFilter').value;
            const facility = document.getElementById('facilityFilter').value;

            filteredData = data.filter(item => {
                const itemYear = new Date(item.관찰일자).getFullYear().toString();
                
                if (year !== 'all' && itemYear !== year) return false;
                if (region !== 'all' && item.시도명 !== region) return false;
                if (facility !== 'all' && item.시설물유형명 !== facility) return false;
                
                return true;
            });

            updateStats();
            updateCharts();
            
            updateMessage(`✅ 필터 적용 완료: ${filteredData.length}건`, 'success');
        }

        function resetFilters() {
            document.getElementById('yearFilter').value = 'all';
            document.getElementById('regionFilter').value = 'all';
            document.getElementById('facilityFilter').value = 'all';
            
            filteredData = [...data];
            updateStats();
            updateCharts();
            
            updateMessage('🔄 필터 초기화 완료', 'success');
        }

        function updateStats() {
            document.getElementById('totalAccidents').textContent = filteredData.length.toLocaleString();
            document.getElementById('totalRegions').textContent = new Set(filteredData.map(item => item.시도명)).size;
            document.getElementById('totalSpecies').textContent = new Set(filteredData.map(item => item.한글보통명)).size;
            
            // 시설물별 통계
            const facilityCounts = {};
            filteredData.forEach(item => {
                facilityCounts[item.시설물유형명] = (facilityCounts[item.시설물유형명] || 0) + 1;
            });
            
            const topFacility = Object.entries(facilityCounts).sort((a, b) => b[1] - a[1])[0];
            if (topFacility) {
                const percentage = ((topFacility[1] / filteredData.length) * 100).toFixed(1);
                document.getElementById('mainFacility').textContent = topFacility[0];
                document.getElementById('facilityPercent').textContent = percentage + '%';
            }
        }

        function createCharts() {
            createMonthlyChart();
            createRegionChart();
            createSpeciesChart();
            createFacilityChart();
        }

        function updateCharts() {
            Object.values(charts).forEach(chart => {
                chart.destroy();
            });
            createCharts();
        }

        function createMonthlyChart() {
            const monthCounts = new Array(12).fill(0);
            filteredData.forEach(item => {
                const month = new Date(item.관찰일자).getMonth();
                monthCounts[month]++;
            });

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                    datasets: [{
                        label: '사고 건수',
                        data: monthCounts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createRegionChart() {
            const regionCounts = {};
            filteredData.forEach(item => {
                regionCounts[item.시도명] = (regionCounts[item.시도명] || 0) + 1;
            });

            const sortedRegions = Object.entries(regionCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            const ctx = document.getElementById('regionChart').getContext('2d');
            charts.region = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedRegions.map(item => item[0]),
                    datasets: [{
                        label: '사고 건수',
                        data: sortedRegions.map(item => item[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createSpeciesChart() {
            const speciesCounts = {};
            filteredData.forEach(item => {
                speciesCounts[item.한글보통명] = (speciesCounts[item.한글보통명] || 0) + 1;
            });

            const sortedSpecies = Object.entries(speciesCounts).sort((a, b) => b[1] - a[1]).slice(0, 6);

            const ctx = document.getElementById('speciesChart').getContext('2d');
            charts.species = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedSpecies.map(item => item[0]),
                    datasets: [{
                        data: sortedSpecies.map(item => item[1]),
                        backgroundColor: ['#667eea', '#764ba2', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createFacilityChart() {
            const facilityCounts = {};
            filteredData.forEach(item => {
                facilityCounts[item.시설물유형명] = (facilityCounts[item.시설물유형명] || 0) + 1;
            });

            const ctx = document.getElementById('facilityChart').getContext('2d');
            charts.facility = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(facilityCounts),
                    datasets: [{
                        data: Object.values(facilityCounts),
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function exportData() {
            let csvContent = "관찰일자,시도명,조류종,시설물유형,개체수\n";
            filteredData.forEach(item => {
                csvContent += `${item.관찰일자},${item.시도명},${item.한글보통명},${item.시설물유형명},${item.개체수}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `조류충돌데이터_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            updateMessage('📁 데이터 내보내기 완료', 'success');
        }

        function showInterface() {
            document.getElementById('filterSection').style.display = 'block';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('chartsGrid').style.display = 'grid';
        }

        function updateMessage(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.textContent = message;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>